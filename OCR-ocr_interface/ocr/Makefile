# Makefile (Version Finalis√©e pour Soutenance)

CC = gcc
CFLAGS = -Wall -Wextra -std=c99 -g
LDFLAGS = -lm # Pour lier les fonctions math√©matiques (expf, etc.)

SRCDIR = src
INCDIR = include
OBJDIR = obj
BINDIR = .

# D√©finition des cibles des ex√©cutables (seront cr√©√©s √† la racine 'ocr/')
TRAIN_TARGET = $(BINDIR)/main
TEST_TARGET = $(BINDIR)/ocr_test
RECON_BIN = $(BINDIR)/reconstruction_final

# Fichiers Objets (seront cr√©√©s dans le r√©pertoire obj/)
COMMON_OBJECTS = $(OBJDIR)/neural_net.o $(OBJDIR)/utils.o $(OBJDIR)/data.o
RECON_OBJ = $(OBJDIR)/reconstruction_final.o

# Liste compl√®te de TOUS les objets n√©cessaires
ALL_OBJECTS = $(COMMON_OBJECTS) $(OBJDIR)/main.o $(OBJDIR)/ocr_test.o $(RECON_OBJ)

# --- R√®gles de compilation principales ---
all: $(ALL_OBJECTS) $(TRAIN_TARGET) $(TEST_TARGET) $(RECON_BIN)

# R√®gle g√©n√©rique pour la compilation des objets (.c vers obj/*.o)
$(OBJDIR)/%.o: $(SRCDIR)/%.c
	@mkdir -p $(OBJDIR)
	$(CC) $(CFLAGS) -I$(INCDIR) -c $< -o $@

# --- 1. R√®gle pour l'Ex√©cutable d'Entra√Ænement (main) ---
$(TRAIN_TARGET): $(COMMON_OBJECTS) $(OBJDIR)/main.o
	$(CC) $(CFLAGS) -o $@ $^ $(LDFLAGS)

# --- 2. R√®gle pour l'Ex√©cutable de Test (ocr_test) ---
$(TEST_TARGET): $(COMMON_OBJECTS) $(OBJDIR)/ocr_test.o
	$(CC) $(CFLAGS) -o $@ $^ $(LDFLAGS)

# --- 3. R√®gle pour l'Ex√©cutable de Reconstruction (reconstruction_final) ---
$(RECON_BIN): $(RECON_OBJ) $(COMMON_OBJECTS)
	$(CC) $(CFLAGS) -o $@ $^ $(LDFLAGS)

# --- R√®gle Sp√©ciale d'Int√©gration ---
reconstruct: $(RECON_BIN)
	@echo "üêç Lancement du pont Python (conversion PNG en pixels...)"
	@python3 decoupage/bridge.py
	@echo "üß† Lancement de la reconnaissance IA C..."
	@./$(RECON_BIN)
	@echo "‚úÖ Fichiers finaux (grid.txt, words.txt) g√©n√©r√©s."

# R√®gle de nettoyage (obligatoire)
clean:
	rm -rf $(OBJDIR)
	rm -f $(TRAIN_TARGET) $(TEST_TARGET) $(RECON_BIN)
	rm -f trained_network.bin trained_xnor.bin
	rm -f grid.txt words.txt decoupage/recon_input.txt
